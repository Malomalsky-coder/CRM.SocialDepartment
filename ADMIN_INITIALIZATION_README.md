# Автоматическая инициализация администратора

## Описание

Система автоматически создает роль `Admin` и пользователя `Admin` с ролью `Admin` при первом запуске приложения, если в системе нет ни одного пользователя с этой ролью.

## Как это работает

### 1. AdminInitializationService

Сервис `AdminInitializationService` выполняет следующие проверки при запуске:

- Проверяет наличие роли `Admin` в системе
- Если роль не найдена - создает её
- Проверяет наличие пользователей с ролью `Admin`
- Если таких пользователей нет - создает пользователя `Admin` с ролью `Admin`

### 2. AdminInitializationHostedService

`AdminInitializationHostedService` - это hosted service, который запускается при старте приложения и автоматически вызывает `AdminInitializationService`.

## Данные по умолчанию

### Роль Admin
- **Название**: `Admin`
- **Описание**: Системная роль администратора

### Пользователь Admin
- **Логин**: `Admin`
- **Пароль**: `Admin`
- **Имя**: `Администратор`
- **Фамилия**: `Системы`
- **Email**: `admin@system.local`
- **Должность**: `Системный администратор`
- **Номер отдела**: `000`
- **Роль**: `Admin`

## Архитектура

### Соблюдение принципов DDD

Система полностью соответствует принципам Domain-Driven Design:

1. **Domain Layer**: Содержит интерфейсы репозиториев (`IUserRepository`, `IRoleRepository`, `IUserRolesRepository`)
2. **Application Layer**: Содержит сервисы приложения (`AdminInitializationService`, `RoleAppService`, `UserAppService`)
3. **Infrastructure Layer**: Содержит реализации репозиториев для MongoDB
4. **Presentation Layer**: Регистрирует hosted service в DI контейнере

### Зависимости

- `AdminInitializationService` зависит от `IUnitOfWork`, `RoleAppService`, `UserAppService`
- `AdminInitializationHostedService` зависит от `AdminInitializationService`
- Все зависимости регистрируются в DI контейнере

## Логирование

Система ведет подробное логирование всех операций:

- Начало инициализации
- Создание роли Admin
- Создание пользователя Admin
- Успешное завершение инициализации
- Ошибки при инициализации

## Безопасность

- Пароль `Admin` хешируется перед сохранением в базу данных
- Используется стандартный механизм хеширования ASP.NET Core Identity
- Пользователь создается с минимальными необходимыми правами

## Настройка

### Регистрация сервисов

В `Program.cs` автоматически регистрируются:

```csharp
builder.Services.AddScoped<AdminInitializationService>();
builder.Services.AddHostedService<AdminInitializationHostedService>();
```

### Запуск

Инициализация происходит автоматически при первом запуске приложения. Никаких дополнительных действий не требуется.

## Мониторинг

После запуска приложения в логах можно увидеть:

```
[INFO] Запуск AdminInitializationHostedService
[INFO] Начинаю проверку наличия администратора в системе
[INFO] Роль Admin не найдена, создаю...
[INFO] Роль Admin успешно создана
[INFO] Пользователи с ролью Admin не найдены, создаю администратора...
[INFO] Пользователь Admin с ролью Admin успешно создан
[INFO] Инициализация администратора завершена успешно
[INFO] Инициализация администратора завершена успешно
```

## Устранение неполадок

### Проблема: Пользователь Admin не создается

1. Проверьте логи на наличие ошибок
2. Убедитесь, что MongoDB доступна
3. Проверьте права доступа к базе данных
4. Убедитесь, что все сервисы зарегистрированы в DI контейнере

### Проблема: Ошибки при создании роли/пользователя

1. Проверьте, что база данных MongoDB запущена
2. Убедитесь, что строка подключения корректна
3. Проверьте права доступа к коллекциям MongoDB

### Проблема: Ошибки компиляции

1. Убедитесь, что все необходимые using директивы добавлены
2. Проверьте, что все зависимости правильно зарегистрированы
3. Убедитесь, что версии пакетов совместимы

## Изменение данных по умолчанию

Для изменения данных по умолчанию отредактируйте метод `CreateAdminUserAsync` в `AdminInitializationService`:

```csharp
private async Task CreateAdminUserAsync()
{
    var createUserDto = new CreateUserDTO
    {
        UserName = "YourAdmin",           // Измените логин
        FirstName = "Ваше имя",           // Измените имя
        LastName = "Ваша фамилия",        // Измените фамилию
        Email = "your.email@domain.com", // Измените email
        Password = "YourPassword",        // Измените пароль
        Role = "Admin",
        Position = "Ваша должность",      // Измените должность
        DepartmentNumber = "001"          // Измените номер отдела
    };
    
    // ... остальной код
}
```

## Тестирование

После запуска приложения:

1. Попробуйте войти в систему с логином `Admin` и паролем `Admin`
2. Проверьте, что пользователь имеет роль `Admin`
3. Убедитесь, что доступны все функции администратора

## Заключение

Система автоматической инициализации администратора обеспечивает:

- Автоматическое создание необходимых ролей и пользователей
- Соблюдение принципов DDD
- Безопасное хранение паролей
- Подробное логирование всех операций
- Простоту настройки и использования

Это решение позволяет быстро развернуть систему и начать работу без необходимости ручного создания администратора.
