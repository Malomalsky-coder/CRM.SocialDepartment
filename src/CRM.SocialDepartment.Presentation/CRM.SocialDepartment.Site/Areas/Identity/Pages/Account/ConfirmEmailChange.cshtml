@page
@model ConfirmEmailChangeModel
@{
    ViewData["Title"] = "Подтверждение смены email";
    Layout = "_LayoutWithoutContainer";
}

<div class="auth-container">
    <div class="auth-card fade-in">
        <div class="auth-header text-center">
            <div class="mb-3">
                @if (Model.StatusMessage?.Contains("Thank you") == true || Model.StatusMessage?.Contains("успешно") == true || Model.StatusMessage?.Contains("confirmed") == true)
                {
                    <i class="fa fa-check-circle text-success" style="font-size: 3rem;"></i>
                }
                else if (Model.StatusMessage?.Contains("Error") == true || Model.StatusMessage?.Contains("ошибка") == true)
                {
                    <i class="fa fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                }
                else
                {
                    <i class="fa fa-envelope-o text-primary" style="font-size: 3rem;"></i>
                }
            </div>
            <h1 class="auth-title">Подтверждение смены email</h1>
        </div>

        <div class="text-center mb-4">
            @if (!string.IsNullOrEmpty(Model.StatusMessage))
            {
                @if (Model.StatusMessage.Contains("Thank you") || Model.StatusMessage.Contains("confirmed") || Model.StatusMessage.Contains("успешно"))
                {
                    <div class="alert alert-success border-0" style="background: rgba(34, 197, 94, 0.1);">
                        <i class="fa fa-check-circle me-2"></i>
                        <strong>Email успешно изменен!</strong><br>
                        Ваш новый адрес электронной почты был успешно подтвержден и активирован в системе.
                    </div>
                }
                else if (Model.StatusMessage.Contains("Error") || Model.StatusMessage.Contains("ошибка"))
                {
                    <div class="alert alert-danger border-0" style="background: rgba(239, 68, 68, 0.1);">
                        <i class="fa fa-exclamation-circle me-2"></i>
                        <strong>Ошибка подтверждения!</strong><br>
                        Произошла ошибка при подтверждении нового email адреса. Возможно, ссылка устарела или была использована ранее.
                    </div>
                }
                else
                {
                    <div class="alert alert-info border-0" style="background: rgba(37, 99, 235, 0.1);">
                        <i class="fa fa-info-circle me-2"></i>
                        @Html.Raw(Model.StatusMessage)
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info border-0" style="background: rgba(37, 99, 235, 0.1);">
                    <i class="fa fa-spinner fa-spin me-2"></i>
                    <strong>Обработка запроса...</strong><br>
                    Подождите, пока мы подтвердим изменение вашего email адреса.
                </div>
            }
        </div>

        <div class="auth-links">
            @if (Model.StatusMessage?.Contains("Thank you") == true || Model.StatusMessage?.Contains("confirmed") == true || Model.StatusMessage?.Contains("успешно") == true)
            {
                <div class="mb-2 text-center">
                    <a href="/Identity/Account/Manage" class="btn btn-primary">
                        <i class="fa fa-user me-1"></i>Управление профилем
                    </a>
                </div>
                <div class="text-center">
                    <a href="/">
                        <i class="fa fa-home me-1"></i>На главную страницу
                    </a>
                </div>
            }
            else if (Model.StatusMessage?.Contains("Error") == true)
            {
                <div class="mb-2 text-center">
                    <a href="/Identity/Account/Manage/Email" class="btn btn-warning">
                        <i class="fa fa-envelope me-1"></i>Изменить email еще раз
                    </a>
                </div>
                <div class="text-center">
                    <a href="/Identity/Account/Manage">
                        <i class="fa fa-arrow-left me-1"></i>Вернуться к управлению профилем
                    </a>
                </div>
            }
            else
            {
                <div class="text-center">
                    <a href="/Identity/Account/Manage">
                        <i class="fa fa-arrow-left me-1"></i>Вернуться к управлению профилем
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<script>
    // Добавляем плавную анимацию появления
    document.addEventListener('DOMContentLoaded', function() {
        const authCard = document.querySelector('.auth-card');
        authCard.style.opacity = '0';
        authCard.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            authCard.style.transition = 'all 0.6s ease-out';
            authCard.style.opacity = '1';
            authCard.style.transform = 'translateY(0)';
        }, 100);

        // Если успешно, автоматически перенаправляем через 5 секунд
        const successAlert = document.querySelector('.alert-success');
        if (successAlert) {
            setTimeout(() => {
                const manageBtn = document.querySelector('a[href="/Identity/Account/Manage"]');
                if (manageBtn && manageBtn.classList.contains('btn')) {
                    manageBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>Перенаправление...';
                    setTimeout(() => {
                        window.location.href = manageBtn.href;
                    }, 1000);
                }
            }, 5000);
        }

        // Если обрабатывается, показываем прогресс
        const processingAlert = document.querySelector('.fa-spinner');
        if (processingAlert) {
            // Обновляем страницу через 3 секунды для проверки статуса
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    });
</script>
