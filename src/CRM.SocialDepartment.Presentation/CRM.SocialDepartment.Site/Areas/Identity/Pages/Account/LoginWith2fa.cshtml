@page
@model LoginWith2faModel
@{
    ViewData["Title"] = "Двухфакторная аутентификация";
    Layout = "_LayoutWithoutContainer";
}

<div class="auth-card">
    <div class="text-center mb-4">
        <i class="fa fa-shield fa-3x text-primary mb-3"></i>
        <h1 class="h3 mb-2">Двухфакторная аутентификация</h1>
        <p class="text-muted">Введите код из приложения-аутентификатора для завершения входа</p>
    </div>

    <form method="post" asp-route-returnUrl="@Model.ReturnUrl">
        <input asp-for="RememberMe" type="hidden" />
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>
        
        <div class="mb-3">
            <label class="form-label text-center w-100 mb-2">
                <i class="fa fa-mobile me-2"></i>Код аутентификации
            </label>
            <div class="input-group justify-content-center">
                <input asp-for="Input.TwoFactorCode" class="form-control text-center" 
                       autocomplete="off" placeholder="000000" maxlength="6" 
                       style="font-size: 1.5rem; letter-spacing: 0.5em; font-weight: bold; width: 200px;" />
            </div>
            <span asp-validation-for="Input.TwoFactorCode" class="invalid-feedback d-block text-center"></span>
            <small class="text-muted text-center d-block mt-2">
                <i class="fa fa-info-circle me-1"></i>
                Введите 6-значный код из вашего приложения
            </small>
        </div>
        
        <div class="form-check mb-3 text-center">
            <input asp-for="Input.RememberMachine" class="form-check-input" type="checkbox" />
            <label asp-for="Input.RememberMachine" class="form-check-label">
                <i class="fa fa-desktop me-1"></i>Запомнить это устройство
            </label>
        </div>
        
        <div class="d-grid mb-3">
            <button id="twoFactorSubmit" type="submit" class="btn btn-primary btn-lg">
                <i class="fa fa-sign-in me-2"></i>Войти в систему
            </button>
        </div>
        
        <div class="text-center">
            <p class="text-muted mb-2">Проблемы с кодом?</p>
            <a asp-page="./LoginWithRecoveryCode" asp-route-returnUrl="@Model.ReturnUrl" class="text-decoration-none">
                <i class="fa fa-key me-1"></i>Использовать код восстановления
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Добавляем плавную анимацию появления
        document.addEventListener('DOMContentLoaded', function() {
            const authCard = document.querySelector('.auth-card');
            authCard.style.opacity = '0';
            authCard.style.transform = 'translateY(30px)';
            
            setTimeout(() => {
                authCard.style.transition = 'all 0.6s ease-out';
                authCard.style.opacity = '1';
                authCard.style.transform = 'translateY(0)';
            }, 100);
        });

        const codeInput = document.querySelector('input[name="Input.TwoFactorCode"]');
        if (codeInput) {
            codeInput.focus();
            
            // Автоматическая отправка при вводе 6 цифр
            codeInput.addEventListener('input', function(e) {
                // Разрешаем только цифры
                this.value = this.value.replace(/\D/g, '');
                
                // Автоотправка при вводе 6 цифр
                if (this.value.length === 6) {
                    setTimeout(() => {
                        this.closest('form').submit();
                    }, 500);
                }
            });

            // Обработка вставки из буфера обмена
            codeInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    this.value = this.value.replace(/\D/g, '').substring(0, 6);
                    if (this.value.length === 6) {
                        setTimeout(() => {
                            this.closest('form').submit();
                        }, 500);
                    }
                }, 10);
            });
        }
        
        // Анимация кнопки при отправке
        document.getElementById('twoFactorSubmit').addEventListener('click', function() {
            const btn = this;
            const icon = btn.querySelector('i');
            
            // Показываем спиннер
            icon.classList.remove('fa-sign-in');
            icon.classList.add('fa-spinner', 'fa-spin');
            btn.disabled = true;
            
            // Возвращаем обратно через 3 секунды (если форма не отправилась)
            setTimeout(() => {
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-sign-in');
                btn.disabled = false;
            }, 3000);
        });
    </script>
}