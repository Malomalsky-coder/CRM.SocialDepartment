# Система логирования активности пользователей

## Обзор

Система логирования активности пользователей (ApplicationUser) позволяет отслеживать все действия пользователей в системе и предоставляет администраторам детальную информацию о том, кто, когда и что делал в системе.

## Возможности

### 1. Автоматическое логирование
- **Авторизация пользователей** - кто, когда и с какого IP адреса вошел в систему
- **Запросы данных** - кто запрашивал информацию о пациентах, пользователях и других сущностях
- **Создание сущностей** - кто создавал новых пациентов, пользователей и другие записи
- **Редактирование сущностей** - кто изменял данные, с сохранением состояния до и после изменений
- **Удаление сущностей** - кто удалял записи из системы

### 2. Детальная информация
- Время выполнения действия (с точностью до секунды)
- IP адрес пользователя
- User Agent браузера
- URL запроса
- HTTP метод
- Полная информация о пользователе (ID, имя пользователя, полное имя)
- Тип и ID затронутой сущности
- Данные до и после изменений (для операций редактирования)

### 3. Фильтрация и поиск
- По типу действия (авторизация, создание, редактирование, удаление, запрос данных)
- По типу сущности (пациент, пользователь, назначение и т.д.)
- По пользователю
- По диапазону дат
- Постраничная навигация

### 4. Статистика
- Общая статистика по типам действий
- Активность по пользователям
- Активность по типам сущностей
- Активность по датам
- Визуализация данных с помощью графиков

### 5. Экспорт данных
- Экспорт логов в JSON формате
- Возможность очистки старых логов

## Архитектура

### Доменный слой
- `UserActivityLog` - основная сущность для хранения логов
- `UserActivityType` - перечисление типов действий
- `IUserActivityLogRepository` - интерфейс репозитория

### Слой приложения
- `UserActivityLogAppService` - сервис для работы с логами
- `UserActivityLoggerService` - сервис для автоматического логирования
- `UserActivityLogDTO` - DTO для передачи данных

### Слой инфраструктуры
- `MongoUserActivityLogRepository` - MongoDB реализация репозитория
- Интеграция с `MongoUnitOfWork`

### Слой представления
- `UserActivityLogController` - контроллер для просмотра логов
- Атрибуты для автоматического логирования:
  - `[LogLogin]` - логирование авторизации
  - `[LogDataRequest]` - логирование запросов данных
  - `[LogCreate]` - логирование создания сущностей
  - `[LogUpdate]` - логирование редактирования сущностей
  - `[LogDelete]` - логирование удаления сущностей

## Использование

### 1. Автоматическое логирование

Система автоматически логирует следующие действия:

#### Авторизация
```csharp
// Автоматически логируется при успешной авторизации
await _userActivityLoggerService.LogLoginAsync(userId, userName, fullName);
```

#### Запросы данных
```csharp
[LogDataRequest("Просмотр пациентов", "Пользователь запросил список пациентов")]
public IActionResult GetPatients()
{
    // Логирование происходит автоматически
}
```

#### Создание сущностей
```csharp
[LogCreate("Patient", "Создание пациента", "Пользователь создал нового пациента")]
public async Task<IActionResult> CreatePatient(CreatePatientViewModel model)
{
    // Логирование происходит автоматически с сохранением данных после создания
}
```

#### Редактирование сущностей
```csharp
[LogUpdate("Patient", "Редактирование пациента", "Пользователь отредактировал данные пациента")]
public async Task<IActionResult> UpdatePatient(Guid id, EditPatientViewModel model)
{
    // Логирование происходит автоматически с сохранением данных до и после изменений
}
```

### 2. Ручное логирование

Для более сложных сценариев можно использовать ручное логирование:

```csharp
// Логирование запроса данных
await _userActivityLoggerService.LogDataRequestAsync(
    userId, userName, fullName, 
    "Специальный запрос", 
    "Пользователь выполнил специальный запрос данных");

// Логирование создания с дополнительными данными
await _userActivityLoggerService.LogEntityCreationAsync(
    userId, userName, fullName,
    "Patient", patientId,
    "Создание пациента", 
    "Пользователь создал пациента через API",
    patientData);

// Логирование обновления с данными до и после
await _userActivityLoggerService.LogEntityUpdateAsync(
    userId, userName, fullName,
    "Patient", patientId,
    "Обновление пациента",
    "Пользователь обновил данные пациента",
    oldData, newData);
```

### 3. Просмотр логов

#### Основной список логов
```
GET /UserActivityLog/Index
```

#### Детальный просмотр лога
```
GET /UserActivityLog/Details/{id}
```

#### Статистика
```
GET /UserActivityLog/Statistics
```

#### Фильтрация
```
GET /UserActivityLog/Index?ActivityType=Create&EntityType=Patient&StartDate=2024-01-01
```

#### Экспорт
```
GET /UserActivityLog/ExportJson?ActivityType=Create&EntityType=Patient
```

## Настройка

### 1. Регистрация сервисов

В `Program.cs` уже добавлены необходимые сервисы:

```csharp
// Регистрация сервисов для логирования активности пользователей
builder.Services.AddHttpContextAccessor();
builder.Services.AddScoped<UserActivityLogAppService>();
builder.Services.AddScoped<UserActivityLoggerService>();
```

### 2. Добавление атрибутов логирования

Для автоматического логирования добавьте соответствующие атрибуты к методам контроллеров:

```csharp
[LogDataRequest("Просмотр активных пациентов", "Пользователь запросил список активных пациентов")]
public IActionResult Active()
{
    return View();
}

[LogCreate("Patient", "Создание пациента", "Пользователь создал нового пациента")]
public async Task<IActionResult> CreatePatient(CreatePatientViewModel model)
{
    // Логика создания
}
```

### 3. Настройка прав доступа

Логи активности доступны только администраторам. Убедитесь, что пользователи имеют роль "Admin":

```csharp
[Authorize(Roles = "Admin")]
public class UserActivityLogController : Controller
{
    // Методы контроллера
}
```

## Структура базы данных

Логи хранятся в MongoDB коллекции `user_activity_logs` со следующей структурой:

```json
{
  "_id": "uuid",
  "UserId": "uuid",
  "UserName": "string",
  "FullName": "string",
  "ActivityType": "enum",
  "ActionName": "string",
  "Description": "string",
  "EntityType": "string",
  "EntityId": "uuid",
  "BeforeChange": "json",
  "AfterChange": "json",
  "IpAddress": "string",
  "UserAgent": "string",
  "RequestUrl": "string",
  "HttpMethod": "string",
  "Timestamp": "datetime",
  "AdditionalData": "json"
}
```

## Производительность

### Рекомендации по оптимизации

1. **Индексы MongoDB**
   ```javascript
   // Создайте индексы для быстрого поиска
   db.user_activity_logs.createIndex({ "Timestamp": -1 })
   db.user_activity_logs.createIndex({ "UserId": 1, "Timestamp": -1 })
   db.user_activity_logs.createIndex({ "ActivityType": 1, "Timestamp": -1 })
   db.user_activity_logs.createIndex({ "EntityType": 1, "EntityId": 1 })
   ```

2. **Очистка старых логов**
   ```csharp
   // Удаление логов старше 90 дней
   await _userActivityLogAppService.DeleteOldLogsAsync(DateTime.UtcNow.AddDays(-90));
   ```

3. **Асинхронное логирование**
   - Все операции логирования выполняются асинхронно
   - Ошибки логирования не прерывают основную логику приложения

## Безопасность

### Защита данных

1. **Доступ только для администраторов**
   - Все методы контроллера защищены атрибутом `[Authorize(Roles = "Admin")]`

2. **Маскирование чувствительных данных**
   - Пароли и другие чувствительные данные не логируются
   - При необходимости можно добавить фильтрацию данных

3. **Ограничение размера логов**
   - Система автоматически ограничивает размер JSON данных
   - Старые логи можно удалять для экономии места

## Мониторинг и уведомления

### Рекомендации по мониторингу

1. **Мониторинг размера коллекции**
   ```javascript
   // Проверка размера коллекции
   db.user_activity_logs.stats()
   ```

2. **Алерты на подозрительную активность**
   - Множественные неудачные попытки авторизации
   - Массовое удаление данных
   - Необычная активность в нерабочее время

3. **Регулярные отчеты**
   - Ежедневные отчеты по активности
   - Еженедельная статистика
   - Месячные сводки

## Расширение функциональности

### Добавление новых типов действий

1. Добавьте новый тип в `UserActivityType`:
   ```csharp
   public enum UserActivityType
   {
       // Существующие типы...
       Export, // Новый тип
   }
   ```

2. Создайте соответствующий атрибут:
   ```csharp
   public class LogExportAttribute : UserActivityLogAttribute
   {
       public LogExportAttribute(string entityType, string actionName, string description) 
           : base(UserActivityType.Export, actionName, description, entityType)
       {
       }
   }
   ```

3. Добавьте отображение в маппинге:
   ```csharp
   CreateMap<UserActivityLog, UserActivityLogDTO>()
       .ForMember(dest => dest.ActivityTypeName, opt => opt.MapFrom(src => 
           src.ActivityType switch
           {
               // Существующие случаи...
               UserActivityType.Export => "Экспорт",
               _ => src.ActivityType.ToString()
           }));
   ```

### Интеграция с внешними системами

Система может быть легко интегрирована с внешними системами мониторинга и аналитики:

1. **Webhook уведомления**
2. **Интеграция с SIEM системами**
3. **Экспорт в системы аналитики**
4. **Интеграция с системами управления инцидентами**

## Заключение

Система логирования активности пользователей предоставляет полную картину действий пользователей в системе, что помогает:

- Обеспечить безопасность и целостность данных
- Отслеживать подозрительную активность
- Аудировать изменения в системе
- Анализировать использование системы
- Соответствовать требованиям регуляторов

Система спроектирована с учетом производительности, масштабируемости и безопасности, что делает её пригодной для использования в производственной среде.
